<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Devamail.temp - Temporary Email</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    body {
      background: #f4f6f8;
      font-family: Arial, sans-serif;
      padding: 20px;
    }
    .email-box {
      background: #fff;
      padding: 20px;
      border-radius: 6px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .email-list {
      max-height: 400px;
      overflow-y: auto;
    }
    .email-list-item {
      cursor: pointer;
    }
    .email-list-item:hover, .email-list-item.active {
      background-color: #f0f4f8;
    }
    .email-body {
      white-space: pre-wrap;
    }
    .fade-in {
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from {opacity: 0;}
      to {opacity: 1;}
    }
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-4 text-center"><i class="fa fa-envelope-open-text text-primary"></i> Devamail.temp</h2>

    <div class="mb-3 d-flex gap-2">
      <button id="generate-btn" class="btn btn-primary"><i class="fa fa-plus"></i> New Email</button>
      <input type="text" id="email-address" class="form-control" readonly />
      <button id="copy-btn" class="btn btn-outline-secondary"><i class="fa fa-copy"></i></button>
      <button id="refresh-btn" class="btn btn-success"><i class="fa fa-sync"></i></button>
      <button id="delete-all-btn" class="btn btn-danger"><i class="fa fa-trash"></i></button>
    </div>

    <div class="row">
      <div class="col-md-4">
        <div class="email-box">
          <h5>Inbox</h5>
          <ul id="email-list" class="list-group email-list mt-2"></ul>
        </div>
      </div>
      <div class="col-md-8">
        <div id="email-content" class="email-box text-muted">Select an email to read</div>
      </div>
    </div>
  </div>

  <!-- Axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script>
    const generateBtn = document.getElementById('generate-btn');
    const emailInput = document.getElementById('email-address');
    const copyBtn = document.getElementById('copy-btn');
    const refreshBtn = document.getElementById('refresh-btn');
    const deleteAllBtn = document.getElementById('delete-all-btn');
    const emailList = document.getElementById('email-list');
    const emailContent = document.getElementById('email-content');

    let currentEmail = '';
    let emails = [];

    async function generateEmail() {
      const res = await axios.post('http://localhost:3001/create-email');
      currentEmail = res.data.email;
      emailInput.value = currentEmail;
      loadEmails();
    }

    async function loadEmails() {
      if (!currentEmail) return;

      try {
        const res = await axios.get(`http://localhost:3001/emails/${encodeURIComponent(currentEmail)}?limit=50`);
        emails = res.data.emails;
        renderEmailList();
        emailContent.innerHTML = emails.length ? 'Select an email to read.' : 'No emails yet.';
      } catch (e) {
        emailContent.innerHTML = 'Failed to load emails.';
      }
    }

    function renderEmailList() {
      emailList.innerHTML = '';
      emails.forEach((email, index) => {
        const li = document.createElement('li');
        li.className = 'list-group-item email-list-item';
        li.innerHTML = `<strong>${email.subject || '(No Subject)'}</strong><br/><small>${email.from}</small><br/><small>${new Date(email.date).toLocaleString()}</small>`;
        li.onclick = () => selectEmail(index, li);
        emailList.appendChild(li);
      });
    }

    let selectedListItem = null;
    function selectEmail(index, li) {
      if (selectedListItem) selectedListItem.classList.remove('active');
      li.classList.add('active');
      selectedListItem = li;

      const email = emails[index];
      emailContent.classList.remove('fade-in');
      void emailContent.offsetWidth;
      emailContent.classList.add('fade-in');

      emailContent.innerHTML = `
        <h5>${email.subject}</h5>
        <p><strong>From:</strong> ${email.from}</p>
        <p><strong>To:</strong> ${email.to}</p>
        <p><strong>Date:</strong> ${new Date(email.date).toLocaleString()}</p>
        <hr/>
        <div class="email-body">${email.text || '[No content]'}</div>
      `;
    }

    copyBtn.onclick = () => {
      navigator.clipboard.writeText(currentEmail).then(() => {
        copyBtn.innerHTML = '<i class="fa fa-check"></i>';
        setTimeout(() => {
          copyBtn.innerHTML = '<i class="fa fa-copy"></i>';
        }, 1500);
      });
    };

    refreshBtn.onclick = () => loadEmails();

    deleteAllBtn.onclick = async () => {
      if (!currentEmail) return;
      if (confirm('Delete all emails for this address?')) {
        await axios.delete(`http://localhost:3001/emails/${encodeURIComponent(currentEmail)}`);
        loadEmails();
        emailContent.innerHTML = 'All emails deleted.';
      }
    };

    generateBtn.onclick = generateEmail;

    // Init on load
    generateEmail();
  </script>
</body>
</html>
